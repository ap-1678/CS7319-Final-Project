<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Task Manager</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0e0f13; --panel:#141722; --panelBorder:#24293b; --ink:#e9ecf1; --muted:#9aa1b3;
      --input:#0f121a; --accent:#6aa6ff; --accent2:#9f7aea;
      --prioLowBg:#0f2a1a; --prioLowBd:#145c39; --prioLowTx:#8cf0b6;
      --prioMedBg:#2a260f; --prioMedBd:#8a6a00; --prioMedTx:#ffd966;
      --prioHighBg:#2a1212; --prioHighBd:#a04444; --prioHighTx:#ffb4b4;
    }
    *{box-sizing:border-box}
    body { margin:0; font-family: system-ui,-apple-system, Segoe UI, Roboto, Helvetica, Arial; background:var(--bg); color:var(--ink); }
    header { display:flex; justify-content:space-between; align-items:center; padding:16px 20px; background:#161a26; border-bottom:1px solid #24293b; }
    h1 { margin:0; font-size:18px; }
    .wrap { max-width: 980px; margin: 24px auto; padding: 0 16px; }
    .card { background:var(--panel); border:1px solid var(--panelBorder); border-radius:14px; padding:16px; margin-bottom:16px; }
    label { display:block; font-size:12px; color:var(--muted); margin:10px 0 4px; }
    input, textarea, select { width:100%; padding:10px; border-radius:10px; border:1px solid var(--panelBorder); background:var(--input); color:var(--ink); }
    textarea { min-height:72px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .btn { padding:10px 14px; background:linear-gradient(135deg,var(--accent),var(--accent2)); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn.text { background:transparent; border:1px solid #2a2f45; }
    .btn.small { padding:6px 10px; font-size:12px; }
    .task { padding:12px; border:1px solid var(--panelBorder); border-radius:12px; margin-top:10px; background:#10131b; }
    .task h3 { margin:0 0 6px; font-size:16px; cursor:pointer; }
    .muted { color:var(--muted); font-size:12px; }
    .flex { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pill { font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid #2a2f45; }
    .sub { display:flex; justify-content:space-between; align-items:center; padding:8px 10px; border-radius:8px; background:#0f121a; border:1px solid #24293b; margin-top:6px; }
    .right { display:flex; gap:8px; align-items:center; }
    .small { font-size:12px; }
    .row3 { display:grid; grid-template-columns: 1fr auto; gap:12px; align-items:center; }
    .datecol { text-align:right; min-width:160px; }
    .datecap { display:block; font-size:11px; color:#9aa1b3; margin-top:2px; }

    /* search toolbar */
    .toolbar { display:flex; gap:10px; align-items:center; margin:12px 0; }
    .searchwrap { position:relative; flex:1; }
    .searchwrap input { padding-left:40px; }
    .searchwrap svg { position:absolute; left:10px; top:50%; transform:translateY(-50%); opacity:.75 }
    .circle-btn { width:40px; height:40px; border-radius:50%; display:grid; place-items:center; background:#121a2a; border:1px solid #2a2f45; cursor:pointer; }
    .menu { position:absolute; z-index:20; background:#1a2030; border:1px solid #2a2f45; border-radius:10px; overflow:hidden; display:none; }
    .menu.open { display:block; }
    .menu h4 { margin:0; padding:8px 10px; font-size:12px; color:#9aa1b3; background:#121827; border-bottom:1px solid #2a2f45; }
    .menu button { display:block; width:220px; text-align:left; padding:10px; background:#192033; color:#e9ecf1; border:none; border-bottom:1px solid #2a2f45; cursor:pointer; }
    .menu button:hover { background:#232b45; }

    /* pivot */
    .pivot { display:none; margin-top:8px; padding-top:8px; border-top:1px dashed #2a2f45; }
    .pivot.open { display:block; }

    /* priority pills */
    .prio { border-radius:999px; padding:2px 8px; font-size:11px; font-weight:700; }
    .prio.low { background:var(--prioLowBg); color:var(--prioLowTx); border:1px solid var(--prioLowBd); }
    .prio.med { background:var(--prioMedBg); color:var(--prioMedTx); border:1px solid var(--prioMedBd); }
    .prio.high { background:var(--prioHighBg); color:var(--prioHighTx); border:1px solid var(--prioHighBd); }

    /* floating + */
    .fab { position:fixed; right:24px; bottom:24px; width:56px; height:56px; border-radius:50%; display:grid; place-items:center; font-size:28px;
      background:#13244c; color:#fff; border:2px solid #27468e; cursor:pointer; z-index:10; }
  </style>
</head>
<body>
<header>
  <h1>Task Manager</h1>
  <div class="flex">
    <span id="username" class="muted" style="font-weight:600"></span>
    <form action="/auth/logout" method="post" style="margin:0">
      <button class="btn text" type="submit">Logout</button>
    </form>
  </div>
</header>

<div class="wrap">

  <!-- Search + filter toolbar -->
  <div class="toolbar">
    <div class="searchwrap">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path stroke="#cdd6f4" stroke-width="2" stroke-linecap="round" d="M21 21l-4.3-4.3"/><circle cx="10.5" cy="10.5" r="6.5" stroke="#cdd6f4" stroke-width="2"/></svg>
      <input id="sf-text" placeholder="Search Task..." />
    </div>
    <div id="filter-btn" class="circle-btn" title="Filter / Sort">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="none"><path d="M3 5h18l-7 8v4l-4 2v-6L3 5z" stroke="#cfe0ff" stroke-width="2" stroke-linejoin="round"/></svg>
    </div>
    <div id="filter-menu" class="menu">
      <h4>Sort</h4>
      <button data-sort="created_desc">Newest</button>
      <button data-sort="created_asc">Oldest</button>
      <button data-sort="due_asc">Due Soonest</button>
      <button data-sort="due_desc">Due Latest</button>
      <button data-sort="title_asc">Title A–Z</button>
      <button data-sort="title_desc">Title Z–A</button>
      <h4>Status</h4>
      <button data-status="">All</button>
      <button data-status="in_progress">In Progress</button>
      <button data-status="completed">Completed</button>
    </div>
  </div>

  <!-- Add Task (hidden; + toggles it) -->
  <div class="card" id="add-card" style="display:none">
    <h2 style="margin:0 0 8px">Add Task</h2>
    <div class="row">
      <div>
        <label>Title</label>
        <input id="t-title" placeholder="e.g., Write Progress Report" />
      </div>
      <div>
        <label>Overall Due Date</label>
        <input id="t-due" type="date" />
      </div>
    </div>
    <label>Description</label>
    <textarea id="t-desc" placeholder="Short description"></textarea>
    <label>Notes</label>
    <textarea id="t-notes" placeholder="Any notes"></textarea>
    <div style="margin-top:12px" class="flex">
      <button class="btn" id="btn-add-task">Add Task</button>
      <button class="btn text" id="btn-cancel-task">Cancel</button>
    </div>
    <div id="status" class="muted" style="margin-top:8px"></div>
  </div>

  <!-- Your Tasks -->
  <div class="card" id="tasks-card">
    <h2 style="margin:0 0 8px">Your Tasks</h2>

    <h3 class="muted" style="margin:0 0 4px;">In Progress</h3>
    <div id="list-inprogress"></div>

    <h3 class="muted" style="margin:12px 0 4px;">Completed</h3>
    <div id="list-completed"></div>
  </div>
</div>

<button class="fab" id="fab" title="Add Task">+</button>

<script>
  // ---------- helpers ----------
  const $ = (id) => document.getElementById(id);
  const esc = (s)=>String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const fmtDate = (s)=>{ if(!s) return ''; try { return new Date(s).toLocaleDateString(); } catch { return s } };
  const toTime = (s)=> s ? new Date(s).getTime() : null;

  async function api(path, options={}) {
    const r = await fetch(path, { headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin', ...options });
    const j = await r.json().catch(()=> ({}));
    if (!r.ok) throw new Error(j.error || (r.status+' '+r.statusText));
    return j;
  }

  // ---------- auth ----------
  async function loadUser() {
    try {
      const r = await fetch('/auth/me', { credentials: 'same-origin' });
      const data = await r.json();
      if (data.user && data.user.username) $('username').textContent = data.user.username;
      else window.location.href = '/';
    } catch { window.location.href = '/'; }
  }

  // ---------- state ----------
  let allTasks = [];
  let sort = 'created_desc';       // created_desc|created_asc|due_asc|due_desc|title_asc|title_desc
  let statusFilter = '';           // ''|in_progress|completed

  function isCompleted(t){
    if (t.status && String(t.status).toLowerCase()==='completed') return true;
    const subs = t.subtasks || [];
    return subs.length>0 && subs.every(s=>!!s.done);
  }
  function normalize(s){ return String(s||'').toLowerCase(); }

  // ---------- process: search/sort/status ----------
  function processTasks(){
    const q = normalize($('sf-text').value);
    let items = [...allTasks];

    // search (title/description/notes)
    if (q) {
      items = items.filter(t =>
        normalize(t.title).includes(q) ||
        normalize(t.description).includes(q) ||
        normalize(t.notes).includes(q)
      );
    }

    // status
    if (statusFilter==='completed') items = items.filter(isCompleted);
    if (statusFilter==='in_progress') items = items.filter(t=>!isCompleted(t));

    // sort
    items.sort((a,b)=>{
      if (sort==='title_asc')  return normalize(a.title).localeCompare(normalize(b.title));
      if (sort==='title_desc') return normalize(b.title).localeCompare(normalize(a.title));

      if (sort==='due_asc' || sort==='due_desc'){
        const da = toTime(a.due_date), db = toTime(b.due_date);
        if (da==null && db==null) return 0;
        if (da==null) return 1; if (db==null) return -1;
        return sort==='due_asc' ? (da-db) : (db-da);
      }

      // created date
      const ca = toTime(a.created_at), cb = toTime(b.created_at);
      if (ca==null && cb==null) return 0;
      if (ca==null) return 1; if (cb==null) return -1;
      return sort==='created_asc' ? (ca-cb) : (cb-ca);
    });

    return items;
  }

  // ---------- UI helpers ----------
  function prioClass(p){ if (String(p)==='1') return 'high'; if (String(p)==='2') return 'med'; return 'low'; }
  function prioLabel(p){ if (String(p)==='1') return 'High'; if (String(p)==='2') return 'Medium'; return 'Low'; }

  // ---------- subtasks render ----------
  function renderSubtasks(host, t){
    host.innerHTML = '';
    (t.subtasks||[]).forEach(st=>{
      const el = document.createElement('div');
      el.className = 'sub';
      el.innerHTML = `
        <div>
          <div style="display:flex; gap:8px; align-items:center;">
            <strong>${esc(st.title)}</strong>
            <span class="prio ${prioClass(st.priority)}">${prioLabel(st.priority)}</span>
            ${st.priority ? `<span class="muted small">(P${st.priority})</span>` : ''}
          </div>
          <div class="muted small">${st.description ? esc(st.description) : ''}</div>
          <div class="muted small">${st.due_date ? 'Due '+fmtDate(st.due_date) : ''}</div>
        </div>
        <div class="right">
          <label class="small"><input type="checkbox" data-st="${t.id}:${st.id}" ${st.done ? 'checked' : ''}/> Done</label>
          <button class="btn text small" data-del-sub="${t.id}:${st.id}" title="Delete sub-task">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" style="vertical-align:middle">
              <path d="M4 7h16M9 7v12m6-12v12M10 4h4l1 3H9l1-3Z" stroke="#cfe0ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
      `;
      host.appendChild(el);

      // toggle done
      el.querySelector('[data-st]').onchange = async (e)=>{
        const [tid, sid] = e.target.dataset.st.split(':');
        try {
          await api(`/tasks/${tid}/subtasks/${sid}/toggle`, { method:'POST', body: JSON.stringify({ done: e.target.checked }) });
          await load(); // refresh lists and split
        } catch (err) {
          alert(err.message||err); e.target.checked = !e.target.checked;
        }
      };

      // delete subtask
      el.querySelector('[data-del-sub]').onclick = async ()=>{
        const [tid, sid] = el.querySelector('[data-del-sub]').dataset.delSub.split(':');
        if (!confirm('Delete this sub-task? This cannot be undone.')) return;
        try { await api(`/tasks/${tid}/subtasks/${sid}`, { method:'DELETE' }); await load(); }
        catch (err) { alert(err.message||err); }
      };
    });
  }

  // ---------- single task card ----------
  function renderTask(t){
    const div = document.createElement('div');
    div.className = 'task';
    div.innerHTML = `
      <div class="row3">
        <div>
          <h3 data-toggle="${t.id}">${esc(t.title || '(Untitled)')}</h3>
          <div class="muted small">${t.description ? esc(t.description) : ''}</div>
        </div>
        <div class="datecol">
          ${t.due_date ? `<div>${fmtDate(t.due_date)}</div><span class="datecap">Due</span>` : `<div>${fmtDate(t.created_at)}</div><span class="datecap">Created</span>`}
        </div>
      </div>

      ${t.notes ? `<div class="muted small" style="margin-top:6px">Notes: ${esc(t.notes)}</div>` : ''}

      <div class="flex" style="margin-top:10px">
        <button class="btn text small" data-del="${t.id}" title="Delete task">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="vertical-align:middle">
            <path d="M4 7h16M9 7v12m6-12v12M10 4h4l1 3H9l1-3Z" stroke="#cfe0ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <button class="btn text small" data-complete="${t.id}">Complete Task</button>
        <button class="btn text small" data-reopen="${t.id}">Reopen Task</button>
        <button class="btn text small" data-new-sub="${t.id}">New Sub-task</button>
      </div>

      <div class="pivot" id="pivot-${t.id}">
        <div id="subs-${t.id}"></div>

        <!-- New sub-task form (hidden until toggled) -->
        <div id="subform-${t.id}" style="display:none; margin-top:10px">
          <div class="row">
            <div>
              <label class="small">Sub-task Title</label>
              <input placeholder="e.g., Collect datasets" data-st-title="${t.id}" />
            </div>
            <div>
              <label class="small">Due Date</label>
              <input type="date" data-st-due="${t.id}" />
            </div>
          </div>
          <label class="small">Description</label>
          <textarea data-st-desc="${t.id}"></textarea>
          <label class="small">Priority</label>
          <select data-st-priority="${t.id}">
            <option value="1">High</option>
            <option value="2">Medium</option>
            <option value="3" selected>Low</option>
          </select>
          <div style="margin-top:8px" class="flex">
            <button class="btn text small" data-add-sub="${t.id}">Add Sub-task</button>
            <button class="btn text small" data-cancel-sub="${t.id}">Cancel</button>
          </div>
        </div>
      </div>
    `;

    // initial subtask render
    renderSubtasks(div.querySelector(`#subs-${t.id}`), t);

    // expand/collapse pivot
    div.querySelector(`[data-toggle="${t.id}"]`).onclick = () => {
      div.querySelector(`#pivot-${t.id}`).classList.toggle('open');
    };

    // new sub-task show/hide
    div.querySelector(`[data-new-sub="${t.id}"]`).onclick = () => {
      const f = div.querySelector(`#subform-${t.id}`);
      const show = f.style.display === 'none' || !f.style.display;
      f.style.display = show ? 'block' : 'none';
      if (show) div.querySelector(`[data-st-title="${t.id}"]`).focus();
    };
    div.querySelector(`[data-cancel-sub="${t.id}"]`).onclick = () => {
      const f = div.querySelector(`#subform-${t.id}`);
      f.style.display = 'none';
      div.querySelector(`[data-st-title="${t.id}"]`).value = '';
      div.querySelector(`[data-st-desc="${t.id}"]`).value = '';
      div.querySelector(`[data-st-due="${t.id}"]`).value = '';
      div.querySelector(`[data-st-priority="${t.id}"]`).value = '3';
    };

    // complete / reopen
    div.querySelector(`[data-complete="${t.id}"]`).onclick = async () => {
      try { await api(`/tasks/${t.id}/complete`, { method:'POST' }); await load(); } catch (e) { alert(e.message); }
    };
    div.querySelector(`[data-reopen="${t.id}"]`).onclick = async () => {
      try { await api(`/tasks/${t.id}/reopen`, { method:'POST' }); await load(); } catch (e) { alert(e.message); }
    };

    // delete task
    div.querySelector(`[data-del="${t.id}"]`).onclick = async () => {
      if (!confirm(`Delete task: "${t.title}"? This cannot be undone.`)) return;
      try { await api('/tasks/'+t.id, { method:'DELETE' }); await load(); }
      catch (e) { alert(e.message); }
    };

    // add subtask
    div.querySelector(`[data-add-sub="${t.id}"]`).onclick = async () => {
      const title = div.querySelector(`[data-st-title="${t.id}"]`).value.trim();
      const description = div.querySelector(`[data-st-desc="${t.id}"]`).value;
      const due = div.querySelector(`[data-st-due="${t.id}"]`).value || null;
      const priority = parseInt(div.querySelector(`[data-st-priority="${t.id}"]`).value || '3', 10);
      if (!title){ alert('Sub-task title is required'); return; }
      try {
        await api(`/tasks/${t.id}/subtasks`, { method:'POST', body: JSON.stringify({ title, description, due_date: due, priority }) });
        div.querySelector(`#subform-${t.id}`).style.display = 'none';
        setTimeout(load, 200); // give backend a moment, then refresh
      } catch (e) { alert(e.message); }
    };

    return div;
  }

  // ---------- render lists ----------
  function renderLists(items){
    const ip = $('list-inprogress'), co = $('list-completed');
    ip.innerHTML = ''; co.innerHTML = '';
    if (!items.length){ ip.innerHTML = '<p class="muted">No tasks found.</p>'; return; }
    items.forEach(t=>{
      const card = renderTask(t);
      (isCompleted(t) ? co : ip).appendChild(card);
    });
  }

  // ---------- fetch + render ----------
  async function load(){
    try {
      const data = await api('/tasks');
      allTasks = data.tasks || data.items || [];
      renderLists(processTasks());
    } catch (e) {
      $('list-inprogress').innerHTML = '<p class="muted">Could not load tasks: '+esc(e.message)+'</p>';
      $('list-completed').innerHTML = '';
    }
  }

  // ---------- add task wiring ----------
  function wireAddTask(){
    $('btn-add-task').onclick = async () => {
      const title = $('t-title').value.trim();
      const description = $('t-desc').value;
      const notes = $('t-notes').value;
      const due = $('t-due').value || null;
      const status = $('status'); status.textContent='';
      if (!title){ status.textContent='Title is required.'; return; }
      try {
        await api('/tasks', { method:'POST', body: JSON.stringify({ title, description, notes, due_date: due }) });
        $('t-title').value=''; $('t-desc').value=''; $('t-notes').value=''; $('t-due').value='';
        $('add-card').style.display='none';
        setTimeout(load, 200); // ensure backend write is visible
      } catch (e) { status.textContent = e.message; }
    };
    $('btn-cancel-task').onclick = () => {
      $('t-title').value=''; $('t-desc').value=''; $('t-notes').value=''; $('t-due').value='';
      $('status').textContent='';
      $('add-card').style.display='none';
    };
    $('fab').onclick = () => {
      const card = $('add-card');
      const show = card.style.display==='none' || !card.style.display;
      card.style.display = show ? 'block' : 'none';
      if (show) setTimeout(()=> $('t-title').focus(), 150);
    };
  }

  // ---------- toolbar wiring ----------
  function wireToolbar(){
    const menu = $('filter-menu'), btn = $('filter-btn');

    // open/close menu
    btn.addEventListener('click', (e)=>{
      e.stopPropagation();
      const rect = btn.getBoundingClientRect();
      menu.style.left = (rect.right - 220) + 'px';
      menu.style.top = (rect.bottom + 6 + window.scrollY) + 'px';
      menu.classList.toggle('open');
    });
    document.addEventListener('click', ()=> menu.classList.remove('open'));
    menu.addEventListener('click', e=> e.stopPropagation());

    // sort -> refresh from backend then render with current search
    menu.querySelectorAll('[data-sort]').forEach(b => b.onclick = async ()=>{
      sort = b.dataset.sort;
      menu.classList.remove('open');
      await load();
    });

    // status -> refresh from backend then render with current search
    menu.querySelectorAll('[data-status]').forEach(b => b.onclick = async ()=>{
      statusFilter = b.dataset.status || '';
      menu.classList.remove('open');
      await load();
    });

    // search (live client-side)
    const search = $('sf-text');
    let tmr=null;
    search.addEventListener('input', ()=>{
      if (tmr) clearTimeout(tmr);
      tmr = setTimeout(()=> renderLists(processTasks()), 120);
    });
    search.addEventListener('keydown', e=>{
      if (e.key==='Enter'){ e.preventDefault(); renderLists(processTasks()); }
    });
  }

  // ---------- boot ----------
  document.addEventListener('DOMContentLoaded', async ()=>{
    await loadUser();
    wireAddTask();
    wireToolbar();
    await load();
  });
</script>
</body>
</html>
