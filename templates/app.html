<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Task Manager</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:#0e0f13; color:#e9ecf1; }
    header { display:flex; justify-content:space-between; align-items:center; padding:16px 20px; background:#161a26; border-bottom:1px solid #24293b; }
    h1 { margin:0; font-size:18px; }
    .wrap { max-width: 980px; margin: 24px auto; padding: 0 16px; }
    .card { background:#141722; border:1px solid #24293b; border-radius:14px; padding:16px; margin-bottom:16px; }
    label { display:block; font-size:12px; color:#9aa1b3; margin:10px 0 4px; }
    input, textarea, select { width:100%; padding:10px; border-radius:10px; border:1px solid #24293b; background:#0f121a; color:#e9ecf1; }
    textarea { min-height:72px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .btn { padding:10px 14px; background:linear-gradient(135deg,#6aa6ff,#9f7aea); color:white; border:none; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn.text { background:transparent; border:1px solid #2a2f45; }
    .task { padding:12px; border:1px solid #24293b; border-radius:12px; margin-top:10px; background:#10131b; }
    .task h3 { margin:0 0 6px; font-size:16px; }
    .muted { color:#9aa1b3; font-size:12px; }
    .flex { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .pill { font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid #2a2f45; }
    .sub { display:flex; justify-content:space-between; align-items:center; padding:8px 10px; border-radius:8px; background:#0f121a; border:1px solid #24293b; margin-top:6px; }
    .right { display:flex; gap:8px; align-items:center; }
    .small { font-size:12px; }
  </style>
</head>
<body>
<header>
  <h1>Task Manager</h1>
  <div class="flex">
    <span id="username" class="muted" style="font-weight:600"></span>
    <form action="/auth/logout" method="post" style="margin:0">
      <button class="btn text" type="submit">Logout</button>
    </form>
  </div>
</header>

  <div class="wrap">

    <div class="card">
      <h2 style="margin:0 0 8px">Add Task</h2>
      <div class="row">
        <div>
          <label>Title</label>
          <input id="t-title" placeholder="e.g., Write Progress Report" />
        </div>
        <div>
          <label>Overall Due Date</label>
          <input id="t-due" type="date" />
        </div>
      </div>
      <label>Description</label>
      <textarea id="t-desc" placeholder="Short description"></textarea>
      <label>Notes</label>
      <textarea id="t-notes" placeholder="Any notes"></textarea>
      <div style="margin-top:12px"><button class="btn" id="btn-add-task">Add Task</button></div>
      <div id="status" class="muted" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <h2 style="margin:0 0 8px">Your Tasks</h2>
      <div id="list"></div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    async function api(path, options={}) {
      const r = await fetch(path, { headers: { 'Content-Type': 'application/json' }, credentials: 'same-origin', ...options });
      const j = await r.json().catch(()=> ({}));
      if (!r.ok) throw new Error(j.error || (r.status+' '+r.statusText));
      return j;
    }

    function fmtDate(s) { if (!s) return ''; try { return new Date(s).toLocaleDateString(); } catch { return s } }

    async function load() {
      try {
        const data = await api('/tasks');
        renderList(data.tasks || []);
      } catch (e) {
        $('list').innerHTML = '<p class="muted">Could not load tasks: '+e.message+'</p>';
      }
    }

    function renderList(tasks) {
      const root = $('list');
      if (tasks.length === 0) { root.innerHTML = '<p class="muted">No tasks yet.</p>'; return; }
      root.innerHTML = '';
      for (const t of tasks) {
        const div = document.createElement('div');
        div.className = 'task';
        div.innerHTML = `
          <h3>${t.title}</h3>
          <div class="muted small">${t.description ? t.description : ''}</div>
          <div class="flex" style="margin-top:6px">
            ${t.due_date ? `<span class="pill">Due ${fmtDate(t.due_date)}</span>` : ''}
            <span class="pill">Progress ${t.progress}%</span>
          </div>
          ${t.notes ? `<div class="muted small" style="margin-top:6px">Notes: ${t.notes}</div>` : ''}
          <div class="flex" style="margin-top:10px">
            <button class="btn text small" data-del="${t.id}">Delete Task</button>
          </div>

          <div style="margin-top:10px">
            <div class="row">
              <div>
                <label class="small">Sub-task Title</label>
                <input placeholder="e.g., Collect datasets" data-st-title="${t.id}" />
              </div>
              <div>
                <label class="small">Due Date</label>
                <input type="date" data-st-due="${t.id}" />
              </div>
            </div>
            <label class="small">Description</label>
            <textarea data-st-desc="${t.id}"></textarea>
            <label class="small">Priority</label>
            <select data-st-priority="${t.id}">
              <option value="1">High</option>
              <option value="2">Medium</option>
              <option value="3" selected>Low</option>
            </select>
            <div style="margin-top:8px"><button class="btn text small" data-add-sub="${t.id}">Add Sub-task</button></div>
          </div>

          <div style="margin-top:8px">
            ${(t.subtasks || []).map(st => `
              <div class="sub">
                <div>
                  <div><strong>${st.title}</strong> ${st.priority ? `<span class="muted small">(P${st.priority})</span>` : ''}</div>
                  <div class="muted small">${st.description || ''}</div>
                  <div class="muted small">${st.due_date ? 'Due '+fmtDate(st.due_date) : ''}</div>
                </div>
                <div class="right">
                  <label class="small"><input type="checkbox" data-toggle="${t.id}:${st.id}" ${st.done ? 'checked' : ''}/> Done</label>
                  <button class="btn text small" data-del-sub="${t.id}:${st.id}">Delete</button>
                </div>
              </div>
            `).join('')}
          </div>
        `;
        root.appendChild(div);
      }

      // Wire buttons
      root.querySelectorAll('[data-del]').forEach(btn => {
        btn.onclick = async () => {
          try { await api('/tasks/'+btn.dataset.del, { method:'DELETE' }); await load(); }
          catch (e) { alert(e.message); }
        };
      });
      root.querySelectorAll('[data-add-sub]').forEach(btn => {
        btn.onclick = async () => {
          const id = btn.dataset.addSub;
          const title = document.querySelector(`[data-st-title="${id}"]`).value;
          const description = document.querySelector(`[data-st-desc="${id}"]`).value;
          const due = document.querySelector(`[data-st-due="${id}"]`).value || null;
          const priority = parseInt(document.querySelector(`[data-st-priority="${id}"]`).value || '3', 10);
          try {
            await api(`/tasks/${id}/subtasks`, { method:'POST', body: JSON.stringify({ title, description, due_date: due, priority }) });
            await load();
          } catch (e) { alert(e.message); }
        };
      });
      root.querySelectorAll('[data-del-sub]').forEach(btn => {
        btn.onclick = async () => {
          const [tid, sid] = btn.dataset.delSub.split(':');
          try { await api(`/tasks/${tid}/subtasks/${sid}`, { method:'DELETE' }); await load(); }
          catch (e) { alert(e.message); }
        };
      });
      root.querySelectorAll('[data-toggle]').forEach(chk => {
        chk.onchange = async () => {
          const [tid, sid] = chk.dataset.toggle.split(':');
          try { await api(`/tasks/${tid}/subtasks/${sid}/toggle`, { method:'POST', body: JSON.stringify({ done: chk.checked }) }); await load(); }
          catch (e) { alert(e.message); chk.checked = !chk.checked; }
        };
      });
    }

    $('btn-add-task').onclick = async () => {
      const title = $('t-title').value.trim();
      const description = $('t-desc').value;
      const notes = $('t-notes').value;
      const due = $('t-due').value || null;
      $('status').textContent = '';
      try {
        await api('/tasks', { method:'POST', body: JSON.stringify({ title, description, notes, due_date: due }) });
        $('t-title').value = ''; $('t-desc').value = ''; $('t-notes').value = ''; $('t-due').value = '';
        await load();
      } catch (e) {
        $('status').textContent = e.message;
      }
    };

    async function loadUser() {
      try {
        const r = await fetch('/auth/me', { credentials: 'same-origin' });
        const data = await r.json();
        if (data.user && data.user.username) {
          document.getElementById('username').textContent = data.user.username;
        } else {
          // If session expired, send back to login page
          window.location.href = '/';
        }
      } catch {
        window.location.href = '/';
      }
    }
    await loadUser();
    await load();
  </script>
</body>
</html>
